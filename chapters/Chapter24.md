_Сериализацией_ (serialization) называется процесс преобразования объекта или графа свызанных объектов в поток байтов. Обратное преобразование называется _десериализацией_ (deserialization). После сериализации появляется возможность дополнительной обработки данных - например, шифрования и сжатия. В .NET Framework существует встроенный механизм сериализации и десериализации.

## Практические пример сериализации/десериализации

_Модулем форматирования_ (formattet) называется тип (он реализует `System.Runtime.Serialization.IFormatter`), умеющий сериализовывать и десериализовывать граф объектов.

Для сериализации графа объектов используется метод `Serialize()` модуля форматирования с передачей в качестве аргументов ссылку на объект потока ввода-вывода и ссылку на сериализцуемый граф. Модуль форматирования знает, как сериализовать весь граф, ссылаясь на описывающие тип каждого объекта метаданные. Для отслеживания состояния экземплярных полей используется отражение. Если какие-то из полей ссылаются на другие объекты, метод сериализует и их. Кроме того, модуль форматирования умеет работать с перекрёстными ссылками и не входит в бесконечные циклы.

При десериализации методом `Deserialize()` в качестве параметра принимается поток ввода-вывода и возвращается ссылка на корневой объект десериализованного графа. При этом исследуется содержимое потока для создания экземпляров всех обнаруженных в потоке объектов.

Следует следить, чтобы сериализация и десериализация производились одним и тем же модулем форматирования. Кроме того, набор графов можно сериализовать в единый поток. Десериализация в таком случае выполняется в том же порядке.

При сериализации в поток записываются полное имя типа и идентификтор сборки. Если такая сборка не найдена в домене при десериализации, то генерируется исключение.

## Сериализуемые типы

В процессе проектирования типа необходимо принять решение о возможности его сериализации. Если для типа планируется сериализация, необходимо пометить тип атрибутом `[Serializable]`. Если хотя бы один из внутренних объектов не поддерживает сериализацию, то будет сгенерировано исключение. По причинам, связанным с производительностью, модуль сериализации не проверяет возможность сериализации для всех объектов в графе. В результате этого данные в потоке ввода-вывода могут быть повреждены. Для возмонжсоти восстановления после таких ситуаций следует использовать `MemoryStream()`.

Атрибут сериализации может быть применн к классам, структурам, перечислениям и делегатам (к последним двум применяется по умолчанию). Атрибут не наследуется производными типами.

В общем случае большинство типов лучше делать сериализуемыми за исключением тех, которые могут содержать конфиденциальные или защищённые данные.

## Управление сериализацией и десериализацией 

После назначения типу атрибута сериализации все экземпляры его полей становятся сериализуемыми (внутри таких типов не стоит определять автосвойства, так как имена полей могут меняться при каждой следующей компиляции). Иногда можно указать некоторые экземпляры как не подлежащие сериализации с помощью атрибута `[NonSerialized]`. Делается это по двум причинам:
- Поле содержит информацию, становящуюся недействительной после десериализации.
- Поля содержат легко обновляемую информацию.

Подобные поля при десериализации могут содежать значение по умолчанию, а не то, которое было на момент сериализации. Решить это можно с использованием метода, помеченного атрибутом `[OnDeserialized]`.

## Сериализация экземпляров типа

Алгоритм сериализации объекта, типу которого назначен атрибут `[Serializable]`:
1. Модуль форматирования получает открытые и закрытые экземплярные поля (исключая не подлежащие сериализации) через отражение. Для каждого сериализуемого полявозвращается по одному объекту типа `MemberInfo`.
2. Полученный массив `MemberInfo` используется для полуения массива `Object`, в котором содержатся значения полей.
3. Модуль форматирования записывает в поток идентификатор сборки и полное имя типа.
4. Модуль записывает в поток имя каждого члена и его значение из массивов.

Алгоритс десериализации подобного объекта:
1. Модуль форматирования читает из потока ввода-вывода идентификатор сборки и полное имя типа. Если сборка не загружена в домен, то модуль загружает её, при невозможности загрузки возникает исключение и десериализация останавливается. Если всё загружено успешно, то модуль получает информацию о типу десериализуемого объекта.
2. Под новый объект выделяется память, но не вызывается конструктор.
3. Тем же способом, что при сериализации, модуль создаёт массив `MemberInfo`.
4. Из содержащихся в потоке данных формируется массив `Object` со значениями полей.
5. Объекты массива перебираются и инициализируют выделенную память.

## Управление сериализованными и десериализованными данными

Иногда встречаются сценарии, когда использование атрибутов для сериализации недостаточно. Кроме того, работа модулей форматировании основана на отрадении, что замедляет процесс. Для получения полного контроля над процедурами сериализации и десериализации и исключения отражения, тип может реализоывать интерфейс [`System.Runtime.Serialization.ISerializable`](https://learn.microsoft.com/ru-ru/dotnet/api/system.runtime.serialization.iserializable?view=net-8.0). При сериализации графа модуль форматирования просматривает каждый объект. Если тип объекта реализует данный интрфейс, то он игнорирует все пользовательские атрбиуты и конструирует новый объект, содержащий реальный набор всех подлежащих сериализации значений объекта.

### Определение типа, реализующего интерфейс ISerializable, не реализуемый базовым классом



## Контексты потока ввода-вывода



## Сериализация в другой тип и десериализация в другой объект



## Сурогаты сериализации



### Цепочка селекторов суррогатов



## Переопределение сборки и/или типа при десериализации объекта

