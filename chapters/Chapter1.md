## Компиляция исходного кода в исполняемые модули

_Общеязыковая среда выволнения_ (Common Language Runtime) - среда выполнения, которая подходит для разных языков программирования. Основные возможности (управление памятью, загрузка сборок, безопасность, обработка исключений, синхронизация) доступных в любых языках, использующих эту среду. 

На рисунке ниже изображён процесс компиляции файлов с исходным кодом. Код может быть написан на любом языке, поддерживаемом CLR. Затем компилятор проверяет синтаксис и анализирует исходный код. Результатом компиляции будет являться _управляемый модуль_ (managed module) - стандартный переносимый исполняемый файл (portable executable: PE32/PE32+), который требует CLR для своего выполнения. Компиляторы машинного кода ориентируются на конкретную процессорную архитектуру. В отличие от этого, все CLR-совместимые компиляторы генерируют IL-код (intermediate language), его иногда называют управляемым, потому что CLR управляет его выполнением.

![image](https://github.com/kuzmin-nikita/CLR-via-CSharp/assets/80389873/4c923aef-5a06-482c-b31a-103b55c122ca)

Каждый компилятор для CLR должен генерировать не только IL-код, но и полные _метаданные_ для каждого управляемого модуля. Метаданные - набор таблиц данных,описывающих, что определено в модуле (например, типы и их члены). Также в метаданных указывается, на что ссылается управляемый модуль (например, импортируемые типы и их члены). Компилятор генерирует метаданные и код одновременно и привязывает их к конечному управляемому модулю, так что рассинхронизация исключена.

Для выполнения управляемого модуля на машине должна быть установлена среда CLR (в составе .NET Framework).

## Объединение управляемых модулей в сборку

CLR работает не с модулями, а со сборками (assembly). В контексте среды CLR сборкой называется то, что обычно зовут _компонентом_.
- Сборка обепечивает логическую группировку одного или нескольких управляемых модулей или файлов ресурсов.
- Сборка является наименьшей единицей многократного использования, безопасности и управления версиями.

Рисунок ниже позволяет понять суть сборки. На рисунке несколько управляемых модулей и ресурсных файлов, с которыми работает программа. Программа создаст единственный PE32+ файл, который обеспечит логическую группировку файлов и при этом включает в себя блок данных, называемый манифестом. Манифест - набор таблиц метаданных. 

![image](https://github.com/kuzmin-nikita/CLR-via-CSharp/assets/80389873/7a4ac223-a46e-42f1-a245-1fd2a1be25da)

Модули сборки также содержат сведения о других сборках, на которые они ссылаются (в том числе номера их версий). Это делает сборку _самоописываемой_. 

## Загрузка CLR

Каждая создаваемая сборка является либо исполняемым приложением, либо DLL. 

После аналиа заголовка для выяснения, какой процесс надо запустить (32- или 64-разрядный) Windows загружает в адресное пространство процесса соответствующую версию библиотеки MSCorEE.dll. Далее основной поток вызывает определённый в MSCorEE.dll метод, который инициализирует CLR, загружает сборки EXE, а затем вызывает её метод Main.

## Исполнение кода сборки
