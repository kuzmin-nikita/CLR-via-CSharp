По-настоящему оценить достоинства .NET Framework помогают _хостинг_ (hosting) и _домены приложений_ (AppDomains). Благодаря хостингу любое приложение может использовать возможности CLR: переписать приложение при помощи управляеиого кода, а также настривать и дополнять приложение на программном уровне.

Домены приложений позволяют решить проблему, при которой загрузка чужих DLL-библиотек могла нарушить безопасность среды.

## Хостинг CLR 

.NET Framework работает поверх Windows, а значит, файлы управляемых модулей и сборок должны иметь формат PE, являться исполняемыми файлами (EXE) или динамически подключаемыми библиотеками (DLL). В Microsoft разработали CLR в виде COM-сервера, содержащегося в DLL. При установке .NET Framework COM-сервер, представляющий CLR, регистрируется в реестре. Любое приложение может стать хостом (управляющим приложением) для CLR. Для создания экземпляра CLR стоит использовать специальную функцию, определённую в библиотеке MSCorEE.dll. Эту библиотеку называют _оболочкой совместимости_ (shim) - она не содержит COM-сервер, но определяет, какую версию CLR необходимо создать. На одной машине может быть несколько версий CLR, но только одна версия оболоски совместимости. Версия MSCorEE.dll совпадает с версией самой последней установленной CLR, так что она знает, как найти предыдущие версии.

Хост-приложние может выполнять следующие операции:
- Устанавливать хост-диспетчеры (host managers), занимающиеся выделением памяти, планированием и синхронизацией потоков, загрузкой сборок и т. п.
- Получать информацию о CLR-диспетчерах, то есть запрещать использовать определённые классы или члены. Хост также может указать подлежащий отладке код, а также методы, вызываемые при определённых событиях (выгрузка домена, исключения и т.д.).
- Инициализировать и запускать CLR.
- Загружать сборку и исполнять её код.
- Останавливать CLR.

## Домены приложений

В ходе инициализации COM-сервер CLR создаёт домен приложений, который является логическим контейнером для набора сборок. Первый из созданных доменов называют _основным_ (default AppDomain), он уничтожается только при завершении процесса. Помимо основного могут создаваться также и дополнительные. Домены удобны благодаря ряду свойств:
- **Объекты, созданные одним доменом приложения, недоступны коду других доменов.** Время жизни объекта ограничивается временем жизни домена. Код другого домена может получить доступ к объекту только при помощи _продвижения по ссылке_ (marshal-by-reference) или _по значению_ (marshal-by-value).
- **Домены приложений можно выгружать.**
- **Домены приложений можно индивидуально защищать.** Домену приложений можно назначить набор разрешений.
- **Домены приложений можно индивидуально настраивать.**

![image](https://github.com/kuzmin-nikita/CLR-via-CSharp/assets/80389873/00b658c4-0a4a-438e-a65c-fc4c5135537e)

У каждого домена есть своя куча загрузчика, ведущая учёт обращения к типа. Если сборка используется в нескольких доменах, то она загружается в каждый домен отдельнол, так как домены разрабатывались для изоляции. Однако, существуют сборки для совместного использования. Они загружаются отдельно и выгружаются при завершении процесса.

### Доступ к объектам из других доменов



## Выгрузка доменов



## Мониторинг доменов



## Уведомление о первом управляемом исключении домена



## Использование хостами доменов приложений



### Исполняемые приложения



### Полнофункциональные интернет-приложения Silverlight



### Microsoft ASP.NET и веб-службы XML



### Microsoft SQL Server



### Будущее и мечты



## Нетривиальное управление хостингом



### Применение управляемого кода



### Разработка надёжных хост-приложений



### Возвращение потока в хост

